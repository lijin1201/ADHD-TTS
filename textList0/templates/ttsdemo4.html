<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ğŸ—£ï¸ TTS Voice Player</title>
  <style>
    body { font-family: sans-serif; margin: 2em; }
    label { font-weight: bold; }
    input[type="text"], textarea, select {
      width: 100%; padding: 0.5em; font-size: 1em; margin-bottom: 1em;
    }
    textarea { height: 100px; }
    button {
      font-size: 1em; padding: 0.6em 1.2em;
      background-color: #4CAF50; color: white;
      border: none; border-radius: 4px; cursor: pointer;
    }
    button:disabled { background-color: #999; }
    #spinner { display: none; margin-top: 1em; }
    .bars { display: none; margin-top: 1em; height: 24px; }
    .bar {
      width: 6px; height: 100%; margin: 0 2px;
      background: #4CAF50; display: inline-block;
      animation: bounce 0.8s infinite ease-in-out;
    }
    .bar:nth-child(2) { animation-delay: 0.1s; }
    .bar:nth-child(3) { animation-delay: 0.2s; }
    .bar:nth-child(4) { animation-delay: 0.3s; }
    .bar:nth-child(5) { animation-delay: 0.4s; }
    @keyframes bounce {
      0%, 100% { transform: scaleY(0.3); }
      50% { transform: scaleY(1); }
    }
    #selectedUrlDisplay {
      margin: 1em 0; padding: 0.5em;
      background: #f0f0f0; border-left: 4px solid #4CAF50;
    }
  </style>
</head>
<body>
  <h2>ğŸ—£ï¸ í…ìŠ¤íŠ¸ ìŒì„± ë³€í™˜ (TTS) ë°ëª¨</h2>

  <label for="preloadedUrls">ğŸ“¡ ì„œë²„ ì„ íƒ (ì‚¬ì „ ë“±ë¡ë¨)</label>
  <select id="preloadedUrls" onchange="syncDropdownToInput()">
    <option value="">-- ì„œë²„ë¥¼ ì„ íƒí•˜ì„¸ìš” --</option>
    <option value="http://localhost:8000/synthesize">ë¡œì»¬ ì„œë²„</option>
    <option value="http://somehost/synthesize">ê¸°ë³¸ ì„œë²„</option>
    <option value="https://texttospeech.googleapis.com/v1/text:synthesize">Google Cloud</option>
  </select>

  <label for="serverUrl">ğŸ”Œ ë˜ëŠ” ì§ì ‘ ì…ë ¥</label>
  <input type="text" id="serverUrl" placeholder="ì˜ˆ: http://localhost:8000/synthesize" />

  <button onclick="setBackendUrl()">âœ… ë°±ì—”ë“œ ì„¤ì •</button>

  <div id="selectedUrlDisplay">âš ï¸ ë°±ì—”ë“œ ì„œë²„ê°€ ì•„ì§ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</div>

  <label for="textInput">ğŸ“ í…ìŠ¤íŠ¸ ì…ë ¥</label>
  <textarea id="textInput" placeholder="ì—¬ê¸°ì— í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”...">ë‚´ì¼ ë‚ ì”¨ ì–´ë•Œìš”?</textarea>

  <button id="playBtn" onclick="synthesizeAndPlay()">â–¶ï¸ ë“£ê¸°</button>
  <div id="spinner">â³ ì²˜ë¦¬ ì¤‘...</div>

  <div class="bars" id="visualizer">
    <div class="bar"></div>
    <div class="bar"></div>
    <div class="bar"></div>
    <div class="bar"></div>
    <div class="bar"></div>
  </div>

  <audio id="player" controls style="margin-top: 1em; display: block;"></audio>

  <!-- âœ… All script comes after DOM -->
  <script>
    let backendUrl = "";

    function syncDropdownToInput() {
      const selected = document.getElementById("preloadedUrls").value;
      if (selected) {
        document.getElementById("serverUrl").value = selected;
      }
    }

    function setBackendUrl() {
      const manual = document.getElementById("serverUrl").value.trim();
      backendUrl = manual;

      const display = document.getElementById("selectedUrlDisplay");
      if (backendUrl) {
        display.innerHTML = `âœ… í˜„ì¬ ë°±ì—”ë“œ ì£¼ì†Œ: <code>${backendUrl}</code>`;
      } else {
        display.innerHTML = `âš ï¸ ë°±ì—”ë“œ ì„œë²„ê°€ ì•„ì§ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.`;
      }
    }

    async function synthesizeAndPlay() {
      const text = document.getElementById("textInput").value.trim();
      const spinner = document.getElementById("spinner");
      const visualizer = document.getElementById("visualizer");
      const playBtn = document.getElementById("playBtn");

      if (!text || !backendUrl) {
        alert("í…ìŠ¤íŠ¸ì™€ ë°±ì—”ë“œ ì£¼ì†Œë¥¼ ëª¨ë‘ ì„¤ì •í•´ì£¼ì„¸ìš”.");
        return;
      }

      playBtn.disabled = true;
      spinner.style.display = "block";
      visualizer.style.display = "none";

      try {
        const formData = new URLSearchParams();
        formData.append("text", text);

        if (backendUrl.startsWith("https://texttospeech.googleapis.com")) {
            const token = 'sample'
            headers = {
                "Authorization": `Bearer ${token}`,
                "x-goog-user-project": "hkit-adhd",
                "Content-Type": "application/json; charset=utf-8"
            };
            body = JSON.stringify({
                input: { text: text },
                voice: {
                languageCode: "ko-KR",
                name: "ko-KR-Wavenet-A"
                },
                audioConfig: {
                audioEncoding: "MP3"
                }
            });
        }   else {
            headers = {
                "Content-Type": "application/x-www-form-urlencoded"
            };

            const formData = new URLSearchParams();
            formData.append("text", text);
            body = formData;
        }

        const response = await fetch(backendUrl, {
            method,
            headers,
            body
        //   method: "POST",
        //   headers: { "Content-Type": "application/x-www-form-urlencoded" },
        //   body: formData
        });

        if (!response.ok) throw new Error("ì‘ë‹µ ì‹¤íŒ¨: " + response.statusText);

        const blob = await response.blob();
        const audioURL = URL.createObjectURL(blob);
        const player = document.getElementById("player");

        player.src = audioURL;
        player.play();

        visualizer.style.display = "block";
        player.onended = () => { visualizer.style.display = "none"; };
      } catch (err) {
        alert("ì˜¤ë¥˜ ë°œìƒ: " + err.message);
      } finally {
        spinner.style.display = "none";
        playBtn.disabled = false;
      }
    }
  </script>
</body>
</html>
